function overlayAjax(config) {
	var backdrop = $("<div>").addClass("modal-backdrop absolute fade in");
	
	var onBeforeAjaxFormValidation = function() {
		if ($.isFunction(config.onBeforeAjaxFormValidation) && 
				config.onBeforeAjaxFormValidation() === false) {
			return false;
		}
		$(config.target).append(backdrop);
	};
	
	var onAjaxFormComplete = function(o) {
		backdrop.remove();
		var appendTarget = $(config.target) || $(config.appendTarget);
		appendTarget.html(o.response);
		
		if ($.isFunction(config.onAjaxFormComplete)){
			config.onAjaxFormComplete(o);
		}
	};
	
	if($.isEmpty(config.form)) {
		if (onBeforeAjaxFormValidation() !== false) {
			$.post(config.url,config.param,function(response,status,options) {
				onAjaxFormComplete({
					response:response,
					status:status,
					options:options
				});
			});
		}
	} else {
		
		var form = $(config.form);
		
		if ($.isEmpty(form.attr("validate")) || !form.attr("validate").booleanValue()) {
			
			form.validationEngine({
				ajaxFormValidation: true,
				dataType:config.dataType || "text",
				ajaxFormValidationMethod:form.attr("method"),
				onBeforeAjaxFormValidation:onBeforeAjaxFormValidation,
				onAjaxFormComplete: function(status, form, response, options){
					onAjaxFormComplete({
						status:status,
						form:form,
						response:response,
						options:options
					});
		        }
			});
			
			form.attr("validate",true);
		}
	}
}

/**
 * 加载模块
 * 
 * @param a accordion下的a标签
 */
function loadModule(a) {
	var action = a.attr("action"),
	url = action.substring(1,action.length),
	title = a.attr("title");
	
	
	overlayAjax({
		url:url.substring(0,url.length -3),
		target:"#module-content",
		onAjaxFormComplete:function(o) {
			$("#module-name").html(title);
			var crumb = $(".breadcrumb"),
			li = $("<li>");
			
			crumb.empty();
			
			a.parents("li").each(function(i,o){
				var html = $(o).children("a").find("span.text").html();
				
				crumb.append(li.clone().html(html));
			});
			
			crumb.append(li.clone().addClass("active").html(title));
		}
	});
}

function initMainCompont() {
	$(".collapse").collapse();
	
	$(".nav.navbar-nav").find("li").children("a").click(function() {
		$(".nav.navbar-nav").find(".accordion").fadeOut("fast");
		$(".nav.navbar-nav").find("li.active").removeClass("active");
		
		var li = $(this).parent();
		li.children(".accordion").fadeIn("fast");
		li.addClass("active");
		
	});
	
	$(".nav.navbar-nav").find(".accordion a").click(function(e){
		var a = $(this);
		a.parents(".accordion").find(".active").removeClass("active");
		a.addClass("active");
		loadModule(a);
	});
}

$(document).ready(function() {
	overlayAjax({
		target:"#main-container",
		url:'main',
		onAjaxFormComplete:initMainCompont
	});
});
